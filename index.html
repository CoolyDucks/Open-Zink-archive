<!doctype html>
<html lang="ar">
<head>
  <meta charset="utf-8" />
  <title>OZA — Open Zink Archive (بروتوتايب)</title>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <style>
    body{font-family:system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;margin:18px;color:#111}
    h1{font-size:1.25rem;margin-bottom:.2rem}
    .muted{color:#666;font-size:.9rem}
    .row{display:flex;gap:10px;flex-wrap:wrap;margin:12px 0}
    .panel{border:1px solid #ddd;padding:12px;border-radius:8px;min-width:280px}
    input[type=file]{display:block}
    button{padding:8px 12px;border-radius:6px;border:0;background:#0b5ed7;color:white;cursor:pointer}
    button.secondary{background:#6c757d}
    progress{width:100%}
    table{width:100%;border-collapse:collapse}
    td,th{padding:6px;border-bottom:1px solid #eee;text-align:left}
    .log{max-height:180px;overflow:auto;background:#f8f9fa;padding:8px;border-radius:6px;border:1px solid #eee;font-size:.9rem}
    label{display:block;margin-bottom:6px}
  </style>
</head>
<body>
  <h1>OZA — Open Zink Archive (بروتوتايب)</h1>
  <div class="muted">واجهة بسيطة لضغط وتجميع ملفات في أرشيف .oza وفكّها داخل المتصفح. لا للمعجزات، فقط عمل عملي.</div>

  <div class="row">
    <div class="panel" style="flex:2">
      <h3>إنشاء أرشيف (.oza)</h3>
      <label>اختر ملفات (متعدد): <input id="filesInput" type="file" multiple /></label>

      <label>مستوى الضغط: <span id="levelVal">6</span>
        <input id="level" type="range" min="1" max="9" value="6"/>
      </label>

      <button id="createBtn">إنشاء OZA</button>
      <div style="margin-top:8px">
        <progress id="createProgress" value="0" max="100" style="display:none"></progress>
      </div>
      <div id="createInfo" class="muted" style="margin-top:8px"></div>
    </div>

    <div class="panel" style="flex:2">
      <h3>فك أرشيف (.oza)</h3>
      <label>رفع ملف .oza: <input id="openInput" type="file" accept=".oza" /></label>
      <button id="listBtn" class="secondary">قائمة الملفات داخل الأرشيف</button>
      <div id="entries" style="margin-top:8px"></div>
      <div style="margin-top:8px">
        <progress id="extractProgress" value="0" max="100" style="display:none"></progress>
      </div>
      <div id="extractInfo" class="muted" style="margin-top:8px"></div>
    </div>
  </div>

  <div class="panel">
    <h3>سجل العملية</h3>
    <div id="log" class="log"></div>
  </div>

  <!-- pako for deflate/inflate -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/2.1.0/pako.min.js"></script>

  <script>
  // ======= Utils =======
  function log(...args){ const d = new Date().toLocaleTimeString(); document.getElementById('log').innerText = d + '  › ' + args.join(' ') + '\n' + document.getElementById('log').innerText }
  function utf8Encode(str){ return new TextEncoder().encode(str) }
  function utf8Decode(buf){ return new TextDecoder().decode(buf) }
  function writeUint32LE(view, offset, v){ view.setUint32(offset, v, true) }
  function writeUint8(view, offset, v){ view.setUint8(offset, v) }
  function writeBigUint64LE(view, offset, v){ view.setBigUint64(offset, BigInt(v), true) }

  // ======= Create OZA =======
  document.getElementById('level').addEventListener('input', e => {
    document.getElementById('levelVal').innerText = e.target.value
  })

  document.getElementById('createBtn').addEventListener('click', async () => {
    const files = Array.from(document.getElementById('filesInput').files)
    if(!files.length){ alert('اختَر ملفات أولاً.'); return }
    const level = parseInt(document.getElementById('level').value,10)
    const progressEl = document.getElementById('createProgress')
    progressEl.style.display = 'block'
    progressEl.value = 0
    log('بدء إنشاء الأرشيف، ملفات:', files.length, 'مستوى ضغط:', level)

    // For streaming approach, we'll collect chunks in array of ArrayBuffers
    const chunks = []
    // write header "OZA1"
    chunks.push(new Uint8Array([0x4f,0x5a,0x41,0x31])) // "OZA1"

    let totalOrig = 0, totalComp = 0
    for(let i=0;i<files.length;i++){
      const f = files[i]
      log('قراءة:', f.name, f.size, 'بايت')
      const ab = await f.arrayBuffer()
      totalOrig += ab.byteLength

      // compress using pako.deflate (returns Uint8Array)
      const compressed = pako.deflate(new Uint8Array(ab), { level })
      totalComp += compressed.length

      const filenameBytes = utf8Encode(f.name)
      // prepare header for entry
      const entryHeaderSize = 4 + filenameBytes.length + 8 + 8 + 1 // nameLen + name + origSize + compSize + compId
      const headerBuf = new ArrayBuffer(entryHeaderSize)
      const dv = new DataView(headerBuf)
      let offset = 0
      writeUint32LE(dv, offset, filenameBytes.length); offset += 4
      new Uint8Array(headerBuf, offset, filenameBytes.length).set(filenameBytes); offset += filenameBytes.length
      writeBigUint64LE(dv, offset, ab.byteLength); offset += 8
      writeBigUint64LE(dv, offset, compressed.length); offset += 8
      writeUint8(dv, offset, 0); offset += 1 // compression id = 0 (deflate)

      chunks.push(new Uint8Array(headerBuf))
      chunks.push(compressed)

      progressEl.value = Math.round(((i+1)/files.length)*100)
      await new Promise(r => setTimeout(r,0)) // allow UI to update
    }

    // concatenate all chunks into one Blob
    const blob = new Blob(chunks, { type: 'application/octet-stream' })
    const url = URL.createObjectURL(blob)
    const a = document.createElement('a')
    a.href = url
    a.download = 'archive.oza'
    a.textContent = 'تحميل archive.oza (انقر يمين -> حفظ أو افتح)'
    // provide download link and stats
    const info = document.getElementById('createInfo')
    info.innerHTML = '<b>جاهز:</b> ' + files.length + ' ملفات — الحجم الأصلي: ' + formatBytes(totalOrig) + ' — الحجم بعد الضغط: ' + formatBytes(totalComp) + ' — <a id="dlLink" href="' + url + '" download="archive.oza">تحميل</a>'
    log('انتهى الإنشاء. الحجم الأصلي:', formatBytes(totalOrig), 'الحجم المضغوط:', formatBytes(totalComp))
    progressEl.style.display = 'none'
  })

  // ======= Extract OZA =======
  document.getElementById('listBtn').addEventListener('click', async () => {
    const f = document.getElementById('openInput').files[0]
    if(!f){ alert('اختر ملف .oza أولاً'); return }
    const ab = await f.arrayBuffer()
    const entries = parseOZA(new Uint8Array(ab))
    if(!entries){ alert('ملف غير صالح أو ترويسة مفقودة'); return }
    const container = document.getElementById('entries')
    container.innerHTML = ''
    const tbl = document.createElement('table')
    tbl.innerHTML = '<tr><th>الملف</th><th>أصلي</th><th>مضغوط</th><th>إجراء</th></tr>'
    for(const e of entries){
      const tr = document.createElement('tr')
      tr.innerHTML = `<td>${escapeHtml(e.name)}</td><td>${formatBytes(Number(e.origSize))}</td><td>${formatBytes(Number(e.compSize))}</td>`
      const td = document.createElement('td')
      const btn = document.createElement('button')
      btn.textContent = 'فك وتحميل'
      btn.addEventListener('click', () => {
        const out = decompressEntry(e)
        const blob = new Blob([out], { type: 'application/octet-stream' })
        const link = document.createElement('a')
        link.href = URL.createObjectURL(blob)
        link.download = e.name
        link.click()
        log('نُزّل:', e.name)
      })
      td.appendChild(btn)
      tr.appendChild(td)
      tbl.appendChild(tr)
    }
    container.appendChild(tbl)
    log('قُرِأ الأرشيف، عدد الملفات:', entries.length)
  })

  // ======= Parsing & helpers =======
  function parseOZA(u8){
    const dv = new DataView(u8.buffer, u8.byteOffset, u8.byteLength)
    // check header
    if(u8.length < 4) return null
    if(String.fromCharCode(u8[0],u8[1],u8[2],u8[3]) !== 'OZA1') return null
    let offset = 4
    const entries = []
    while(offset < u8.length){
      if(offset + 4 > u8.length) break
      const nameLen = dv.getUint32(offset, true); offset += 4
      if(offset + nameLen > u8.length) break
      const nameBytes = new Uint8Array(u8.buffer, u8.byteOffset + offset, nameLen); offset += nameLen
      const name = utf8Decode(nameBytes)
      if(offset + 8 + 8 + 1 > u8.length) break
      const origSize = dv.getBigUint64(offset, true); offset += 8
      const compSize = dv.getBigUint64(offset, true); offset += 8
      const compId = dv.getUint8(offset); offset += 1
      if(offset + Number(compSize) > u8.length) break
      const compData = new Uint8Array(u8.buffer, u8.byteOffset + offset, Number(compSize)); offset += Number(compSize)
      entries.push({ name, origSize, compSize, compId, compData })
    }
    return entries
  }

  function decompressEntry(e){
    if(e.compId === 0){
      // deflate/inflate via pako
      const inflated = pako.inflate(e.compData)
      return inflated.buffer
    } else {
      throw new Error('خوارزمية ضغط غير مدعومة: ' + e.compId)
    }
  }

  function formatBytes(n){
    if(n < 1024) return n + ' B'
    const u = ['B','KB','MB','GB','TB']
    let i = 0
    let v = Number(n)
    while(v >= 1024 && i < u.length-1){ v /= 1024; i++ }
    return v.toFixed( (i===0)?0:2 ) + ' ' + u[i]
  }

  function escapeHtml(s){ return s.replace(/[&<>"']/g, (m)=>({ '&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;' })[m]) }

  // ======= small notes in log / startup =======
  log('OZA prototype ready. استخدم الجزء العلوي لضغط وفك الأرشيفات.')
  </script>
</body>
  </html>
